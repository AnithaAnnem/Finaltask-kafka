@Library('KafkaSharedLib') _  // Link your shared library

pipeline {
    agent any

    environment {
        ANSIBLE_KEY   = '/var/lib/jenkins/.ssh/MYKAFKA.pem'
        ANSIBLE_USER  = 'ubuntu'
        INVENTORY     = 'finalcluster/aws_ec2.yml'
        PLAYBOOK      = 'finalcluster/site.yml'
        GIT_REPO      = 'https://github.com/AnithaAnnem/Finaltask-kafka.git'
        GIT_BRANCH    = 'main'
    }

    stages {
        stage('Pipeline') {
            steps {
                script {
                    def kafka = new org.cloudninja.kafka.template.KafkaDeployment(steps)

                    // ===== Git Checkout =====
                    kafka.checkoutCode(GIT_REPO, GIT_BRANCH)

                    // ===== Ansible CI Checks =====
                    kafka.ansibleLint(PLAYBOOK)
                    kafka.ansibleSyntaxCheck(INVENTORY, PLAYBOOK)
                    kafka.ansibleDryRun(INVENTORY, PLAYBOOK, ANSIBLE_USER, ANSIBLE_KEY)

                    // ===== Deploy =====
                    kafka.deployZookeeper(INVENTORY, PLAYBOOK, ANSIBLE_USER, ANSIBLE_KEY)
                    kafka.deployKafka(INVENTORY, PLAYBOOK, ANSIBLE_USER, ANSIBLE_KEY)
                }
            }
        }
    }

    post {
        success {
            echo "Kafka/Zookeeper deployment completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check logs for details."
        }
        always {
            echo "Cleaning workspace..."
            cleanWs()
        }
    }
}
